<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AmbuLink - Layanan Ambulans Terdekat</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>

    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
    />

    <link rel="stylesheet" href="/src/input.css" />

    <!-- Extension Error Suppressor -->
    <script>
      (function () {
        // Aggressive error suppression for extension-related errors
        const originalConsoleError = console.error;
        const suppressPatterns = [
          "The message port closed before a response was received",
          "Unchecked runtime.lastError",
          "Extension context invalidated",
          "Cannot access a chrome",
          "Extension manifest",
          "chrome.runtime",
        ];

        // Override console.error completely
        console.error = function (...args) {
          if (args.length === 0) return;

          // Convert all arguments to string for checking
          const errorString = args
            .map((arg) =>
              typeof arg === "string"
                ? arg
                : arg instanceof Error
                ? arg.message
                : String(arg)
            )
            .join(" ");

          // Check if error matches any suppress pattern
          if (
            suppressPatterns.some((pattern) => errorString.includes(pattern))
          ) {
            return; // Silently ignore these errors
          }

          // Pass through other errors
          originalConsoleError.apply(console, args);
        };

        // Intercept and suppress error events
        window.addEventListener(
          "error",
          function (event) {
            if (
              suppressPatterns.some((pattern) =>
                (event.error?.message || event.message || "").includes(pattern)
              )
            ) {
              event.preventDefault();
              event.stopPropagation();
              return false;
            }
          },
          true
        );

        // Intercept and suppress unhandled promise rejection events
        window.addEventListener(
          "unhandledrejection",
          function (event) {
            if (
              suppressPatterns.some((pattern) =>
                (event.reason?.message || event.reason || "").includes(pattern)
              )
            ) {
              event.preventDefault();
              event.stopPropagation();
              return false;
            }
          },
          true
        );

        // Override chrome API if it exists
        if (window.chrome) {
          try {
            // Create a proxy to intercept chrome API access
            const chromeProxy = new Proxy(
              {},
              {
                get: function (target, prop) {
                  // Return a no-op function for any method call
                  return function () {
                    return undefined;
                  };
                },
              }
            );

            // Try to override chrome API
            Object.defineProperty(window, "chrome", {
              value: chromeProxy,
              writable: false,
              configurable: false,
            });
          } catch (e) {
            // Silently fail if we can't override chrome
          }
        }

        // Clean up on page unload
        window.addEventListener("beforeunload", function () {
          // Attempt to clean up any remaining message ports
          if (window.chrome?.runtime?.connect) {
            try {
              const port = chrome.runtime.connect();
              if (port && port.disconnect) {
                port.disconnect();
              }
            } catch (e) {}
          }
        });
      })();
    </script>

    <script type="module" src="js/chat-bot.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");

      body {
        font-family: "Poppins", sans-serif;
        background-color: #f8f9fa;
      }

      #map {
        height: 500px;
        width: 100%;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .ambulance-card {
        transition: all 0.3s ease;
        border: 1px solid #e5e7eb;
      }

      .ambulance-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .toast {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        z-index: 9999;
        padding: 1rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease-out;
      }

      .location-buttons {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        gap: 12px;
      }

      .location-button {
        @apply bg-white text-[#AA1919] px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition-colors border border-[#AA1919] flex items-center justify-center;
      }

      @keyframes slideIn {
        from {
          transform: translateY(100%);
          opacity: 0;
        }

        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .gradient-bg {
        background: linear-gradient(135deg, #aa1919 0%, #8b0000 100%);
      }

      /* Add responsive styles for the header */
      @media (max-width: 768px) {
        .container {
          padding: 0 0.5rem;
        }

        .space-x-4 > * + * {
          margin-left: 0.5rem;
        }

        .text-2xl {
          font-size: 1.25rem;
        }

        .location-button {
          padding: 0.5rem 0.75rem;
        }

        #authButtons {
          margin-left: 0.5rem;
        }
      }

      @media (max-width: 640px) {
        .location-button span,
        #authButtons span {
          display: none;
        }

        .location-button i,
        #authButtons i {
          margin-right: 0;
        }

        .space-x-4 > * + * {
          margin-left: 0.25rem;
        }
      }
    </style>
  </head>

  <body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
      <div class="container mx-auto px-4">
        <div
          class="flex flex-wrap items-center justify-between gap-4 md:gap-6 py-4 md:py-2"
        >
          <!-- Logo -->
          <div class="flex items-center py-1">
            <a href="/" class="flex items-center space-x-2 md:space-x-3">
              <i
                class="fas fa-ambulance text-xl md:text-2xl text-[#AA1919]"
              ></i>
              <span class="text-lg md:text-2xl font-bold text-[#AA1919]"
                >AmbuLink</span
              >
            </a>
          </div>

          <!-- Hamburger Menu (Mobile) -->
          <div class="md:hidden">
            <button id="menuToggle" class="text-[#AA1919] focus:outline-none">
              <i class="fas fa-bars text-2xl"></i>
            </button>
          </div>

          <!-- Navigation Items -->
          <div
            id="menuItems"
            class="hidden md:flex items-center flex-wrap gap-3 md:gap-4"
          >
            <button
              id="locateMe"
              class="location-button flex items-center text-[#AA1919] hover:text-[#8B0000] border border-[#AA1919] px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition-colors"
            >
              <i class="fas fa-location-arrow mr-2 text-[#AA1919]"></i>
              Lokasi Saya
            </button>

            <a
              href="/tambah.html"
              id="addAmbulansBtn"
              class="mr-5 md:m-0 location-button flex items-center text-[#AA1919] hover:text-[#8B0000] border border-[#AA1919] px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition-colors"
              onclick="handleAddAmbulans(event)"
            >
              <i class="fas fa-plus mr-2"></i>
              Tambah Ambulans
            </a>

            <!-- Auth Buttons -->
            <div id="authButtons" class="flex items-center space-x-4">
              <a
                href="/login.html"
                id="loginBtn"
                class="flex items-center text-blue-800 hover:text-[#AA1919] transition-colors text-sm md:text-base"
              >
                <i class="fas fa-sign-in-alt mr-2"></i>
                Masuk
              </a>
              <a
                href="/register.html"
                id="registerBtn"
                class="text-gray-600 hover:text-[#AA1919] transition-colors"
              >
                <i class="fas fa-user-plus mr-2"></i>
                Daftar
              </a>
              <button
                id="logoutBtn"
                style="display: none"
                class="text-gray-600 flex items-center hover:text-[#AA1919] transition-colors"
              >
                <i class="fas fa-sign-out-alt mr-2"></i>
                Keluar
              </button>
            </div>
          </div>
        </div>

        <!-- Mobile Menu (Dropdown) Improved -->
        <div
          id="mobileMenu"
          class="md:hidden hidden flex-col gap-4 mt-4 bg-white p-4 rounded-xl shadow-lg border border-red-100"
        >
          <!-- Section: Actions -->
          <div class="flex flex-col gap-3">
            <button
            id="locateMe"
              class="flex items-center justify-center text-[#AA1919] border border-[#AA1919] px-4 py-2 rounded-lg font-medium hover:bg-[#fef2f2] transition-colors w-full"
            >
              <i class="fas fa-location-arrow mr-2 text-[#AA1919]"></i>
              Lokasi Saya
            </button>

            <a
              href="/tambah.html"
              class="flex items-center justify-center text-[#AA1919] border border-[#AA1919] px-4 py-2 rounded-lg font-medium hover:bg-[#fef2f2] transition-colors w-full"
            >
              <i class="fas fa-plus mr-2"></i>
              Tambah Ambulans
            </a>
          </div>

          <!-- Divider -->
          <hr class="border-t border-gray-200 my-2" />

          <!-- Section: Auth -->
          <div class="flex flex-col gap-2 text-center">
            <a
              href="/login.html"
              class="text-blue-800 hover:text-[#AA1919] transition-colors flex justify-center items-center"
              id="mobileLoginBtn"
            >
              <i class="fas fa-sign-in-alt mr-2"></i> Masuk
            </a>
            <a
              href="/register.html"
              class="text-gray-600 hover:text-[#AA1919] transition-colors flex justify-center items-center"
              id="mobileRegisterBtn"
            >
              <i class="fas fa-user-plus mr-2"></i> Daftar
            </a>
            <button
              class="text-gray-600 hover:text-[#AA1919] transition-colors flex justify-center items-center"
              id="mobileLogoutBtn"
            >
              <i class="fas fa-sign-out-alt mr-2"></i> Keluar
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Hero Section -->
    <div class="gradient-bg shadow-lg overflow-hidden mb-8">
      <div
        class="container mx-auto max-w-6xl flex flex-col-reverse md:flex-row items-center justify-between px-6 sm:px-8 py-12 sm:py-16 gap-8"
      >
        <!-- Text Section -->
        <div class="text-center md:text-left md:w-1/2">
          <h1
            class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white mb-4 leading-tight"
          >
            Temukan Ambulans Terdekat
          </h1>
          <p
            class="text-gray-100 text-base sm:text-lg mb-6 sm:mb-8 leading-relaxed"
          >
            AmbuLink membantu Anda menemukan layanan ambulans terdekat dengan
            cepat dan mudah. Bandingkan layanan, fasilitas, dan biaya untuk
            mendapatkan bantuan yang tepat.
          </p>
          <button
            id="locateMe"
            class="bg-white text-[#AA1919] px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors flex items-center justify-center mx-auto md:mx-0 w-full sm:w-auto"
          >
            <span>Mulai Pencarian</span>
            <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>

        <!-- Image Section -->
        <div class="flex justify-center md:w-1/2">
          <img
            src="images/img.png"
            alt="Ambulance illustration"
            class="w-4/5 sm:w-full max-w-xs sm:max-w-md lg:max-w-lg rounded-xl"
          />
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
      <!-- Filter Section -->
      <div
        class="bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-8 w-full"
        id="filter-pencarian"
      >
        <h3 class="text-xl font-semibold mb-6 text-gray-800 flex items-center">
          <i class="fas fa-filter mr-2 text-[#AA1919]"></i>
          Filter Pencarian
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-6">
          <!-- Radius Pencarian -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Radius Pencarian</label
            >
            <select
              id="filterRadius"
              class="w-full rounded-lg border-gray-300 shadow-sm focus:border-[#AA1919] focus:ring focus:ring-[#AA1919]/50 hover:border-[#AA1919] transition duration-200"
            >
              <option value="0">Semua Jarak</option>
              <option value="1">1 km</option>
              <option value="2">2 km</option>
              <option value="3">3 km</option>
              <option value="5">5 km</option>
              <option value="10">10 km</option>
            </select>
          </div>

          <!-- Provinsi -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Provinsi</label
            >
            <select
              id="filterProvinsi"
              class="w-full rounded-lg border-gray-300 shadow-sm focus:border-[#AA1919] focus:ring focus:ring-[#AA1919]/50 hover:border-[#AA1919] transition duration-200"
            >
              <option value="">Semua Provinsi</option>
            </select>
          </div>

          <!-- Kota -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Kota</label
            >
            <select
              id="filterKota"
              class="w-full rounded-lg border-gray-300 shadow-sm focus:border-[#AA1919] focus:ring focus:ring-[#AA1919]/50 hover:border-[#AA1919] transition duration-200"
              disabled
            >
              <option value="">Semua Kota</option>
            </select>
          </div>

          <!-- Tipe Instansi -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Tipe Instansi</label
            >
            <select
              id="filterTipe"
              class="w-full rounded-lg border-gray-300 shadow-sm focus:border-[#AA1919] focus:ring focus:ring-[#AA1919]/50 hover:border-[#AA1919] transition duration-200"
            >
              <option value="">Semua Tipe</option>
              <option value="rumah_sakit">Rumah Sakit</option>
              <option value="pmi">PMI</option>
              <option value="klinik">Klinik</option>
              <option value="lainnya">Lainnya</option>
            </select>
          </div>

          <!-- Jenis Layanan -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Jenis Layanan</label
            >
            <select
              id="filterJenisLayanan"
              class="w-full rounded-lg border-gray-300 shadow-sm focus:border-[#AA1919] focus:ring focus:ring-[#AA1919]/50 hover:border-[#AA1919] transition duration-200"
            >
              <option value="">Semua Layanan</option>
              <option value="gawat_darurat">Gawat Darurat</option>
              <option value="non_gawat_darurat">Non Gawat Darurat</option>
              <option value="transportasi">Transportasi</option>
              <option value="jenazah">Jenazah</option>
            </select>
          </div>

          <!-- Status Layanan -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Status Layanan</label
            >
            <select
              id="filterStatus"
              class="w-full rounded-lg border-gray-300 shadow-sm focus:border-[#AA1919] focus:ring focus:ring-[#AA1919]/50 hover:border-[#AA1919] transition duration-200"
            >
              <option value="">Semua Status</option>
              <option value="gratis">Gratis</option>
              <option value="berbayar">Berbayar</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Content Section -->
      <div class="flex flex-wrap gap-8 mb-16">
        <!-- Map Section -->
        <div class="w-full md:flex-[2_1_0%] min-w-0">
          <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="p-6">
              <div
                id="map"
                class="relative w-full"
                style="z-index: 0; height: calc(100vh - 400px)"
              ></div>
            </div>
          </div>
        </div>

        <!-- Ambulance Cards Section -->
        <div class="w-full md:flex-[1_1_0%] min-w-0">
          <div class="bg-white rounded-xl shadow-lg p-6">
            <div
              id="ambulanceList"
              class="grid grid-cols-1 gap-4"
              style="height: calc(100vh - 400px); overflow-y: auto"
            >
              <!-- Cards will be inserted here by JavaScript -->
            </div>
          </div>
        </div>

        <!-- Modal Review -->
        <div
          id="reviewModal"
          class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center"
        >
          <div class="bg-white p-6 rounded-md max-w-md w-full">
            <button onclick="closeReviewModal()">✕</button>
            <input type="hidden" id="reviewAmbulansId" />
            <div id="reviewList" class="mt-4 space-y-2"></div>
            <form id="reviewForm" class="mt-4">
              <textarea
                id="reviewKomentar"
                class="w-full border p-2 rounded"
                placeholder="Tulis komentar..."
              ></textarea>
              <div class="flex space-x-1 mt-2">
                <button type="button" class="star-btn" data-rating="1">
                  ★
                </button>
                <button type="button" class="star-btn" data-rating="2">
                  ★
                </button>
                <button type="button" class="star-btn" data-rating="3">
                  ★
                </button>
                <button type="button" class="star-btn" data-rating="4">
                  ★
                </button>
                <button type="button" class="star-btn" data-rating="5">
                  ★
                </button>
              </div>
              <button
                type="submit"
                class="mt-3 bg-red-600 text-white px-4 py-2 rounded"
              >
                Kirim
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Add Chart.js -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

      <!-- Add statistics section after filter section -->
      <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-8">
        <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
          <i class="fas fa-chart-bar mr-2 text-[#AA1919]"></i>
          Statistik & Rekomendasi
        </h3>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- Statistik -->
          <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="bg-gray-50 p-4 rounded-lg h-full">
              <h4 class="font-semibold text-sm mb-2 text-[#AA1919]">
                Distribusi Tipe Ambulans
              </h4>
              <div class="h-[200px] flex items-center justify-center">
                <canvas id="ambulanceTypeChart"></canvas>
              </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg h-full">
              <h4 class="font-semibold text-sm mb-2 text-[#AA1919]">
                Status Layanan Ambulans
              </h4>
              <div class="h-[200px] flex items-center justify-center">
                <canvas id="ambulanceStatusChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Rekomendasi Terdekat -->
          <div class="bg-gray-50 p-4 rounded-lg h-full">
            <h4 class="font-semibold text-sm mb-2 text-[#AA1919]">
              Ambulans Terdekat
            </h4>
            <div
              id="nearestAmbulance"
              class="h-[200px] overflow-y-auto pr-2 space-y-2"
            >
              <!-- Will be filled by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Scripts -->
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
      <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

      <!-- Your existing JavaScript code remains unchanged -->
      <script>
        // Suppress Chrome extension errors completely
        window.addEventListener("error", (event) => {
          if (
            event.error?.message?.includes(
              "The message port closed before a response was received"
            )
          ) {
            event.preventDefault(); // Prevent the error from appearing in console
          }
        });

        // Remove mandatory authentication check
        let isAuthenticated = false;
        const token = localStorage.getItem("token");
        if (token) {
          isAuthenticated = true;
        }
        updateUI();

        let map = null;
        let markers = [];
        let ambulanceData = [];
        let userMarker = null;
        let userLocation = null;
        let routingControl = null;
        let locationCircle = null; // For accuracy radius
        let isManualLocationMode = false;
        let ambulanceTypeChart = null;
        let ambulanceStatusChart = null;

        //navbar
        const menuToggle = document.getElementById("menuToggle");
        const mobileMenu = document.getElementById("mobileMenu");

        menuToggle.addEventListener("click", () => {
          mobileMenu.classList.toggle("hidden");
        });
        // Custom icons
        const ambulanceIcon = L.icon({
          iconUrl:
            "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
          shadowUrl:
            "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41],
        });

        const userIcon = L.divIcon({
          className: "user-location-marker",
          html: `<div style="
                      width: 20px;
                      height: 20px;
                      background-color: #4A90E2;
                      border: 3px solid white;
                      border-radius: 50%;
                      box-shadow: 0 0 10px rgba(0,0,0,0.5);
                      position: relative;
                  ">
                      <div style="
                          position: absolute;
                          top: 50%;
                          left: 50%;
                          transform: translate(-50%, -50%);
                          width: 30px;
                          height: 30px;
                          background-color: rgba(74, 144, 226, 0.3);
                          border-radius: 50%;
                          animation: pulse 2s infinite;
                      "></div>
                  </div>`,
          iconSize: [20, 20],
          iconAnchor: [10, 10],
        });

        // Add pulse animation style
        const style = document.createElement("style");
        style.textContent = `
                  @keyframes pulse {
                      0% {
                          transform: translate(-50%, -50%) scale(1);
                          opacity: 1;
                      }
                      100% {
                          transform: translate(-50%, -50%) scale(3);
                          opacity: 0;
                      }
                  }
              `;
        document.head.appendChild(style);

        // Initialize map and load data
        document.addEventListener("DOMContentLoaded", async () => {
          // Initialize map only if it hasn't been initialized
          if (!map) {
            initMap();
          }
          await loadProvinsiData();
          await loadAmbulanceData();
          await getCurrentLocation();
          setupEventListeners();
          updateUI();

          // Check authentication
          const token = localStorage.getItem("token");
          isAuthenticated = !!token;

          // Handle provinsi change
          document
            .getElementById("filterProvinsi")
            .addEventListener("change", (e) => {
              updateKotaOptions(e.target.value);
              handleFilterChange();
            });

          // Handle kota change
          document
            .getElementById("filterKota")
            .addEventListener("change", handleFilterChange);
        });

        // Update UI based on authentication
        function updateUI() {
          const loginBtn = document.getElementById("loginBtn");
          const registerBtn = document.getElementById("registerBtn");
          const logoutBtn = document.getElementById("logoutBtn");

          const mobileLoginBtn = document.getElementById("mobileLoginBtn");
          const mobileRegisterBtn =
            document.getElementById("mobileRegisterBtn");
          const mobileLogoutBtn = document.getElementById("mobileLogoutBtn");

          const addAmbulansBtn = document.getElementById("addAmbulansBtn");

          if (isAuthenticated) {
            // Desktop
            if (loginBtn) loginBtn.style.display = "none";
            if (registerBtn) registerBtn.style.display = "none";
            if (logoutBtn) logoutBtn.style.display = "flex";

            // Mobile
            if (mobileLoginBtn) mobileLoginBtn.style.display = "none";
            if (mobileRegisterBtn) mobileRegisterBtn.style.display = "none";
            if (mobileLogoutBtn) mobileLogoutBtn.style.display = "flex";

            // Enable Add Ambulans
            addAmbulansBtn.onclick = () =>
              (window.location.href = "/tambah.html");
          } else {
            // Desktop
            if (loginBtn) loginBtn.style.display = "flex";
            if (registerBtn) registerBtn.style.display = "flex";
            if (logoutBtn) logoutBtn.style.display = "none";

            // Mobile
            if (mobileLoginBtn) mobileLoginBtn.style.display = "flex";
            if (mobileRegisterBtn) mobileRegisterBtn.style.display = "flex";
            if (mobileLogoutBtn) mobileLogoutBtn.style.display = "none";

            // Disable Add Ambulans
            addAmbulansBtn.onclick = (e) => {
              e.preventDefault();
              alert(
                "Anda harus login terlebih dahulu untuk menambah ambulans."
              );
            };
          }
        }

        document
          .getElementById("logoutBtn")
          ?.addEventListener("click", handleLogout);
        document
          .getElementById("mobileLogoutBtn")
          ?.addEventListener("click", handleLogout);

        function handleLogout() {
          localStorage.removeItem("token");
          isAuthenticated = false;
          updateUI();
          showToast("Berhasil logout", "success");
        }

        // Function to handle Add Ambulans button click
        function handleAddAmbulans(event) {
          if (!isAuthenticated) {
            event.preventDefault();
            alert("Anda harus login terlebih dahulu untuk menambah ambulans.");
            return false;
          }
          window.location.href = "/tambah.html";
        }

        // Add ambulance button click handler
        document
          .getElementById("addAmbulansBtn")
          ?.addEventListener("click", () => {
            if (!isAuthenticated) {
              showToast(
                "Silakan login terlebih dahulu untuk menambah ambulans",
                "info"
              );
              setTimeout(() => {
                window.location.href = "/login.html";
              }, 2000);
              return;
            }
            window.location.href = "/tambah.html";
          });

        // Login button click handler
        document.getElementById("loginBtn")?.addEventListener("click", () => {
          window.location.href = "/login.html";
        });

        // Logout button click handler

        //document.getElementById("logoutBtn")?.addEventListener("click", () => {
        //localStorage.removeItem("token");
        //isAuthenticated = false;
        //updateUI();
        //showToast("Berhasil logout", "success");
        //});

        // Initialize map
        function initMap() {
          // Check if map is already initialized
          if (map) {
            console.warn("Map is already initialized");
            return;
          }

          map = L.map("map").setView([-2.5489, 118.0149], 5);

          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "© OpenStreetMap contributors",
          }).addTo(map);

          // Add click handler for manual location selection
          map.on("click", function (e) {
            if (isManualLocationMode) {
              setManualLocation(e.latlng);
            }
          });
        }

        // Set manual location
        function setManualLocation(latlng) {
          userLocation = [latlng.lat, latlng.lng];

          if (userMarker) {
            map.removeLayer(userMarker);
          }

          userMarker = L.marker([latlng.lat, latlng.lng], {
            icon: userIcon,
            draggable: true, // Allow marker to be dragged
          })
            .addTo(map)
            .bindPopup("Lokasi Anda (drag untuk mengubah)")
            .openPopup();

          // Update location when marker is dragged
          userMarker.on("dragend", function (event) {
            const marker = event.target;
            const position = marker.getLatLng();
            userLocation = [position.lat, position.lng];
            updateMarkers();
          });

          map.setView([latlng.lat, latlng.lng], 13);
          showToast("Lokasi berhasil dipilih!", "success");
          isManualLocationMode = false;
          updateMarkers();

          // Update cursor style
          document.getElementById("map").style.cursor = "";
        }

        // Get current location
        async function getCurrentLocation() {
          try {
            showToast("Mencari lokasi Anda...", "info");

            if (!navigator.geolocation) {
              throw new Error("Browser Anda tidak mendukung geolokasi");
            }

            const position = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0,
              });
            });

            userLocation = [
              position.coords.latitude,
              position.coords.longitude,
            ];

            if (userMarker) {
              map.removeLayer(userMarker);
            }

            // Add user marker with custom icon
            userMarker = L.marker(userLocation, {
              icon: userIcon,
              zIndexOffset: 1000, // Make sure user marker is always on top
              draggable: true,
            }).addTo(map);

            // Add a popup to the user marker
            userMarker
              .bindPopup("Lokasi Anda (geser untuk mengubah)")
              .openPopup();

            // Center map on user location with animation
            map.flyTo(userLocation, 13, {
              duration: 1.5,
              easeLinearity: 0.25,
            });

            // Update when marker is dragged
            userMarker.on("dragend", function (e) {
              userLocation = [
                e.target.getLatLng().lat,
                e.target.getLatLng().lng,
              ];
              updateNearestAmbulance();
              updateRadiusVisualization();
            });

            // Initial updates
            updateNearestAmbulance();
            updateRadiusVisualization();
            showToast("Lokasi berhasil ditemukan!", "success");

            return true;
          } catch (error) {
            console.error("Error getting location:", error);
            let errorMessage = "Gagal mendapatkan lokasi: ";

            if (error.code === 1) {
              errorMessage +=
                "Izin lokasi ditolak. Aktifkan izin lokasi di browser Anda.";
            } else if (error.code === 2) {
              errorMessage += "Lokasi tidak tersedia. Pastikan GPS aktif.";
            } else if (error.code === 3) {
              errorMessage += "Waktu pencarian lokasi habis.";
            } else {
              errorMessage += error.message;
            }

            showToast(errorMessage, "error");
            return false;
          }
        }

        function isValidCoordinates(lat, lng) {
          return (
            !isNaN(lat) &&
            !isNaN(lng) &&
            lat >= -90 &&
            lat <= 90 &&
            lng >= -180 &&
            lng <= 180
          );
        }

        // Save last known location
        function saveLastLocation(location) {
          try {
            localStorage.setItem("lastLocation", JSON.stringify(location));
          } catch (e) {
            console.error("Error saving location:", e);
          }
        }

        // Try to load last known location
        function tryLoadLastLocation() {
          try {
            const lastLocation = localStorage.getItem("lastLocation");
            if (lastLocation) {
              const [lat, lng] = JSON.parse(lastLocation);
              if (isValidCoordinates(lat, lng)) {
                userLocation = [lat, lng];
                userMarker = L.marker(userLocation, {
                  icon: userIcon,
                  draggable: true,
                })
                  .addTo(map)
                  .bindPopup("Lokasi terakhir Anda (drag untuk mengubah)")
                  .openPopup();

                map.setView(userLocation, 13);
                updateMarkers();
                showToast("Menggunakan lokasi terakhir yang tersimpan", "info");
                return true;
              }
            }
          } catch (e) {
            console.error("Error loading last location:", e);
          }
          return false;
        }

        // Enable manual location selection
        function enableManualLocationSelection() {
          isManualLocationMode = true;
          document.getElementById("map").style.cursor = "crosshair";
          showToast("Klik pada peta untuk memilih lokasi Anda", "info");
        }

        // Add click handler for location button with retry
        document
          .getElementById("locateMe")
          .addEventListener("click", async () => {
            const success = await getCurrentLocation();
            if (!success) {
              showToast("Klik tombol lokasi untuk mencoba lagi", "info");
            }
          });

        // Clean up function
        function cleanupMap() {
          if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
          }

          markers.forEach((marker) => {
            if (marker) {
              map.removeLayer(marker);
            }
          });
          markers = [];

          if (userMarker) {
            map.removeLayer(userMarker);
            userMarker = null;
          }
        }

        // Show toast message
        function showToast(message, type = "info") {
          const toast = document.createElement("div");
          toast.className = `toast ${
            type === "error"
              ? "bg-red-100 text-red-700"
              : type === "success"
              ? "bg-green-100 text-green-700"
              : "bg-blue-100 text-blue-700"
          }`;
          toast.textContent = message;
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
        }

        // Handle filter changes
        function handleFilterChange() {
          updateCards();
          updateMarkers();
        }

        // Get route to ambulance
        function getRoute(destination, name) {
          if (!userLocation) {
            showToast("Aktifkan lokasi Anda terlebih dahulu", "error");
            return;
          }

          // Clean up existing route if any
          if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
          }

          // Create new route
          routingControl = L.Routing.control({
            waypoints: [
              L.latLng(userLocation[0], userLocation[1]),
              L.latLng(destination[0], destination[1]),
            ],
            router: L.Routing.osrmv1({
              serviceUrl: "https://router.project-osrm.org/route/v1",
              profile: "driving",
            }),
            lineOptions: {
              styles: [{ color: "#AA1919", weight: 6 }],
            },
            createMarker: function () {
              return null;
            }, // Don't create additional markers
            show: false,
            addWaypoints: false,
            routeWhileDragging: false,
            fitSelectedRoutes: true,
          }).addTo(map);

          routingControl.on("routesfound", function (e) {
            const routes = e.routes;
            const route = routes[0];
            const distance = (route.summary.totalDistance / 1000).toFixed(1);
            const duration = Math.round(route.summary.totalTime / 60);

            // Fit the map to show the entire route
            map.fitBounds(L.latLngBounds(route.coordinates));

            // Show route info
            showToast(
              `Rute ke ${name}: ${distance} km (±${duration} menit)`,
              "info"
            );
          });
        }

        // Load ambulance data
        async function loadAmbulanceData() {
          try {
            const response = await fetch("/api/ambulans");

            if (!response.ok) {
              throw new Error("Failed to fetch ambulance data");
            }

            const data = await response.json();

            // Ensure ambulanceData is always an array
            ambulanceData = Array.isArray(data) ? data : data.data || [];

            // console.log("Loaded ambulance data:", ambulanceData);

            if (ambulanceData.length === 0) {
              showToast("Tidak ada data ambulans yang tersedia", "info");
              return;
            }

            // Parse fasilitas for each ambulance if it's a JSON string
            ambulanceData = ambulanceData.map((ambulance) => {
              let parsedFasilitas;
              let fasilitasOriginal = ambulance.fasilitas;
              if (typeof fasilitasOriginal === "string") {
                let fasilitasString = fasilitasOriginal;
                console.log(
                  `Ambulance ID: ${ambulance.id || "N/A"}, Nama: ${
                    ambulance.nama || "N/A"
                  }, fasilitas STRING akan di-parse:`,
                  ambulance.fasilitas // Cetak string fasilitas mentah
                );

                if (
                  fasilitasString &&
                  fasilitasString.startsWith("{") &&
                  fasilitasString.endsWith("}") &&
                  !fasilitasString.includes(":")
                ) {
                  console.warn(
                    `Memperbaiki format fasilitas dari: "${fasilitasString}"`
                  );
                  // Modifikasi fasilitasString
                  fasilitasString =
                    "[" +
                    fasilitasString.substring(1, fasilitasString.length - 1) +
                    "]";
                  console.warn(`Menjadi (sebelum parse): "${fasilitasString}"`);
                }

                try {
                  // Gunakan fasilitasString yang sudah (kemungkinan) dimodifikasi
                  parsedFasilitas = JSON.parse(fasilitasString || "[]");
                } catch (e) {
                  console.error(
                    `ERROR parsing fasilitas untuk Ambulance ID: ${
                      ambulance.id || "N/A"
                    }, Nama: ${
                      ambulance.nama || "N/A"
                    }. String fasilitas (setelah potensi perbaikan):`,
                    fasilitasString, // Ini adalah string yang coba di-parse dan gagal
                    "String fasilitas ASLI:",
                    fasilitasOriginal,
                    "Error object:",
                    e
                  );
                  parsedFasilitas = [];
                }
              } else if (Array.isArray(fasilitasOriginal)) {
                parsedFasilitas = fasilitasOriginal;
              } else {
                parsedFasilitas = [];
              }

              return {
                ...ambulance,
                fasilitas: parsedFasilitas,
              };
            });

            // Update UI components
            updateFilters();
            updateCards();
            updateMarkers();
            updateStatistics();
            if (userLocation) {
              updateNearestAmbulance();
            }
          } catch (error) {
            console.error("Error loading ambulance data:", error);
            showToast("Gagal memuat data ambulans: " + error.message, "error");
          }
        }

        // Filter ambulance data
        function filterAmbulanceData() {
          const filters = {
            provinsi: document.getElementById("filterProvinsi").value,
            kota: document.getElementById("filterKota").value,
            tipe: document.getElementById("filterTipe").value,
            jenisLayanan: document.getElementById("filterJenisLayanan").value,
            status: document.getElementById("filterStatus").value,
            radius: document.getElementById("filterRadius")?.value || 0,
          };

          // console.log("Applying filters:", filters);

          return ambulanceData.filter((ambulance) => {
            // Basic filters
            const matchProvinsi =
              !filters.provinsi ||
              ambulance.provinsi?.toLowerCase() ===
                filters.provinsi.toLowerCase();
            const matchKota =
              !filters.kota ||
              ambulance.kota?.toLowerCase() === filters.kota.toLowerCase();
            const matchTipe =
              !filters.tipe ||
              ambulance.tipe_instansi?.toLowerCase() ===
                filters.tipe.toLowerCase();
            const matchJenisLayanan =
              !filters.jenisLayanan ||
              ambulance.jenis_layanan?.toLowerCase() ===
                filters.jenisLayanan.toLowerCase();
            const matchStatus =
              !filters.status ||
              ambulance.status?.toLowerCase() === filters.status.toLowerCase();

            // Radius filter
            let matchRadius = true;
            if (userLocation && filters.radius > 0) {
              const distance = calculateDistance(
                userLocation[0],
                userLocation[1],
                ambulance.latitude,
                ambulance.longitude
              );
              matchRadius = distance <= filters.radius;
            }

            return (
              matchProvinsi &&
              matchKota &&
              matchTipe &&
              matchJenisLayanan &&
              matchStatus &&
              matchRadius
            );
          });
        }

        // Update nearest ambulance
        async function updateNearestAmbulance() {
          const nearestContainer = document.getElementById("nearestAmbulance");

          if (!userLocation || !ambulanceData || ambulanceData.length === 0) {
            console.log(
              "Lokasi belum tersedia untuk mencari ambulans terdekat"
            );
            nearestContainer.innerHTML =
              '<p class="text-gray-500">Aktifkan lokasi untuk melihat ambulans terdekat</p>';
            return;
          }

          try {
            // Get filtered data first
            const filteredByCity = document.getElementById("filterKota").value;
            let filteredData = ambulanceData;

            if (filteredByCity) {
              filteredData = ambulanceData.filter(
                (ambulance) =>
                  ambulance.kota.toLowerCase() === filteredByCity.toLowerCase()
              );
            }

            // Calculate distance for each ambulance
            const ambulancesWithDistance = filteredData.map((ambulance) => ({
              ...ambulance,
              distance: calculateDistance(
                userLocation[0],
                userLocation[1],
                parseFloat(ambulance.latitude),
                parseFloat(ambulance.longitude)
              ),
            }));

            // Filter ambulances within 10km and sort by distance
            const nearestAmbulances = ambulancesWithDistance
              .filter((ambulance) => ambulance.distance <= 10) // Only show ambulances within 10km
              .sort((a, b) => a.distance - b.distance)
              .slice(0, 5); // Show top 5 nearest

            // Update UI
            if (nearestAmbulances.length === 0) {
              nearestContainer.innerHTML =
                '<p class="text-gray-500">Tidak ada ambulans dalam radius 10km</p>';
              return;
            }

            nearestContainer.innerHTML = nearestAmbulances
              .map(
                (ambulance) => `
                          <div class="bg-white rounded-lg shadow p-4 mb-4 hover:shadow-lg transition-shadow">
                              <div class="flex justify-between items-start">
                                  <h4 class="font-semibold text-gray-800">${
                                    ambulance.nama
                                  }</h4>
                                  <span class="text-sm ${
                                    ambulance.status === "gratis"
                                      ? "text-green-600"
                                      : "text-gray-600"
                                  }">
                                      ${ambulance.status.toUpperCase()}
                                  </span>
                              </div>
                              <p class="text-sm text-gray-600 mt-1">
                                  <i class="fas fa-map-marker-alt text-red-500 mr-1"></i>
                            ${ambulance.alamat}
                        </p>
                              <p class="text-sm text-gray-600 mt-1">
                                  <i class="fas fa-road text-blue-500 mr-1"></i>
                                  Jarak: ${ambulance.distance.toFixed(1)} km
                              </p>
                              <button onclick="getRoute([${
                                ambulance.latitude
                              }, ${
                  ambulance.longitude
                }], '${ambulance.nama.replace(/'/g, "\\'")}')"
                                      class="mt-2 w-full bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors">
                                  <i class="fas fa-directions mr-1"></i>
                                  Lihat Rute
                              </button>
                        </div>
                      `
              )
              .join("");
          } catch (error) {
            // console.error("Error updating nearest ambulance:", error);
            nearestContainer.innerHTML =
              '<p class="text-red-500">Gagal memuat data ambulans terdekat</p>';
          }
        }

        // Calculate distance between two points in kilometers
        function calculateDistance(lat1, lon1, lat2, lon2) {
          const R = 6371; // Radius of the Earth in kilometers
          const dLat = ((lat2 - lat1) * Math.PI) / 180;
          const dLon = ((lon2 - lon1) * Math.PI) / 180;
          const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos((lat1 * Math.PI) / 180) *
              Math.cos((lat2 * Math.PI) / 180) *
              Math.sin(dLon / 2) *
              Math.sin(dLon / 2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
          return R * c;
        }

        // Function to create ambulance card
        function createAmbulanceCard(ambulance) {
          console.log("Creating card for ambulance:", ambulance); // Debug log
          const card = document.createElement("div");
          card.className = "bg-white rounded-lg shadow-lg p-6 ambulance-card";

          const distance = userLocation
            ? calculateDistance(
                userLocation[0],
                userLocation[1],
                parseFloat(ambulance.latitude),
                parseFloat(ambulance.longitude)
              )
            : null;

          const fasilitas = Array.isArray(ambulance.fasilitas)
            ? ambulance.fasilitas
            : [];

          // Format rating jika ada
          const rating = ambulance.rating ? Number(ambulance.rating) : 0;
          const jumlahRating = ambulance.jumlah_rating || 0;
          const ratingStars =
            "★".repeat(Math.round(rating)) + "☆".repeat(5 - Math.round(rating));
          const ratingDisplay = `
                      <div class="flex items-center space-x-1">
                          <div class="text-yellow-400 text-lg">${ratingStars}</div>
                          <span class="text-gray-600">(${rating.toFixed(
                            1
                          )})</span>
                          <span class="text-gray-400">${jumlahRating} review</span>
                      </div>
                  `;

          card.innerHTML = `
                      <div class="flex justify-between items-start mb-4">
                          <h3 class="text-xl font-bold text-gray-800">${
                            ambulance.nama || ""
                          }</h3>
                        ${ratingDisplay}
                    </div>

                      <!-- Tipe dan Status -->
                      <div class="flex items-center justify-between mb-4">
                          <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                              ${getTipeInstansiLabel(ambulance.tipe_instansi)}
                          </span>
                          <span class="px-3 py-1 ${
                            ambulance.status === "gratis"
                              ? "bg-green-100 text-green-800"
                              : "bg-yellow-100 text-yellow-800"
                          } rounded-full text-sm">
                              ${
                                ambulance.status === "gratis"
                                  ? "Gratis"
                                  : formatPrice(ambulance.harga || 0)
                              }
                          </span>
                </div>

                      <!-- Informasi Utama -->
                      <div class="space-y-3 mb-4">
                          <div class="flex items-start">
                              <i class="fas fa-map-marker-alt text-red-500 mt-1 w-5"></i>
                              <span class="text-gray-600 flex-1">${
                                ambulance.alamat || ""
                              }, ${ambulance.kota || ""}, ${
            ambulance.provinsi || ""
          }</span>
                    </div>

                    <div class="flex items-center">
                              <i class="fas fa-ambulance text-blue-500 w-5"></i>
                              <span class="text-gray-600">${getJenisLayananLabel(
                                ambulance.jenis_layanan
                              )}</span>
                    </div>

                          ${
                            ambulance.jam_operasional
                              ? `
                    <div class="flex items-center">
                        <i class="fas fa-clock text-blue-500 w-5"></i>
                              <span class="text-gray-600">${ambulance.jam_operasional}</span>
                    </div>
                          `
                              : ""
                          }

                          ${
                            distance
                              ? `
                          <div class="flex items-center">
                              <i class="fas fa-route text-green-500 w-5"></i>
                              <span class="text-gray-600">${distance.toFixed(
                                1
                              )} km dari lokasi Anda</span>
                </div>
                          `
                              : ""
                          }
                      </div>

                      <!-- Kontak -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                          <button href="tel:${ambulance.kontak}"
                             class="flex items-center justify-center bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600 transition-colors">
                              <i class="fas fa-phone mr-2"></i>
                              ${ambulance.kontak}
                      </button>
                          ${
                            ambulance.whatsapp
                              ? `
                              <a href="https://wa.me/${ambulance.whatsapp.replace(
                                /\D/g,
                                ""
                              )}" target="_blank"
                                  class="flex items-center justify-center bg-[#25D366] text-white px-3 py-2 rounded text-sm hover:bg-[#128C7E] transition-colors">
                                  <i class="fab fa-whatsapp mr-2"></i>
                                  ${ambulance.whatsapp}
                              </a>
                          `
                              : `
                              <button disabled class="flex items-center justify-center bg-gray-300 text-white px-3 py-2 rounded text-sm cursor-not-allowed">
                                  <i class="fab fa-whatsapp mr-2"></i>
                                  Tidak tersedia
                              </button>
                          `
                          }
                </div>

                      <!-- Fasilitas -->
                      ${
                        fasilitas.length > 0
                          ? `
                      <div class="mb-4">
                          <h4 class="font-medium text-gray-700 mb-2">Fasilitas:</h4>
                    <div class="flex flex-wrap gap-2">
                              ${fasilitas
                                .map(
                                  (f) => `
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                      <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                ${f}
                            </span>
                              `
                                )
                                .join("")}
                    </div>
                </div>
                      `
                          : ""
                      }

                      <!-- Deskripsi -->
                      ${
                        ambulance.deskripsi
                          ? `
                      <div class="mb-4">
                          <h4 class="font-medium text-gray-700 mb-2">Deskripsi:</h4>
                          <p class="text-gray-600 text-sm">${ambulance.deskripsi}</p>
                      </div>
                      `
                          : ""
                      }

                      <!-- Action Buttons -->
                      <div class="grid grid-cols-2 gap-2">
                          ${
                            userLocation
                              ? `
                          <button onclick="getRoute([${ambulance.latitude}, ${
                                  ambulance.longitude
                                }], '${ambulance.nama.replace(/'/g, "\\'")}')"
                                  class="flex items-center justify-center bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                        <i class="fas fa-directions mr-2"></i>Lihat Rute
                    </button>
                          `
                              : `
                          <button onclick="getCurrentLocation()"
                                  class="flex items-center justify-center bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                              <i class="fas fa-location-arrow mr-2"></i>Aktifkan Lokasi
                          </button>
                          `
                          }
                    <button onclick="showReviewModal(${ambulance.id})"
                                  class="flex items-center justify-center bg-gray-100 text-gray-700 px-4 py-2 rounded hover:bg-gray-200 transition-colors">
                              <i class="fas fa-star mr-2"></i>Lihat Review
                    </button>
                </div>
            `;
          return card;
        }

        // Update popup content
        function createPopupContent(ambulans) {
          const popupContent = document.createElement("div");
          popupContent.className = "p-4";
          popupContent.style.maxWidth = "300px";

          const distance = userLocation
            ? calculateDistance(userLocation, [
                ambulans.latitude,
                ambulans.longitude,
              ])
            : null;

          // Format rating jika ada
          const rating = ambulans.rating ? Number(ambulans.rating) : 0;
          const jumlahRating = ambulans.jumlah_rating || 0;
          const ratingDisplay =
            rating > 0
              ? `<div class="flex items-center text-yellow-400 mb-2">
                    <span class="font-medium">${rating.toFixed(1)}</span>
                    <i class="fas fa-star ml-1"></i>
                    <span class="text-gray-500 ml-1">(${jumlahRating})</span>
                      </div>`
              : "";

          popupContent.innerHTML = `
                <div class="text-lg font-bold mb-2">${ambulans.nama}</div>
                ${ratingDisplay}
                <div class="space-y-2 text-sm">
                    <div class="flex items-center">
                        <i class="fas fa-phone text-green-500 w-5"></i>
                              <a href="tel:${
                                ambulans.kontak
                              }" class="hover:text-blue-500 ml-2">${
            ambulans.kontak
          }</a>
                    </div>
                    <div class="flex items-center">
                        <i class="fab fa-whatsapp text-[#25D366] w-5"></i>
                              ${
                                ambulans.whatsapp
                                  ? `<a href="https://wa.me/${ambulans.whatsapp.replace(
                                      /\D/g,
                                      ""
                                    )}" target="_blank"
                                class="hover:text-blue-500 ml-2">
                                ${ambulans.whatsapp}
                                  </a>`
                                  : `<span class="text-gray-500 ml-2">-</span>`
                              }
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-building text-blue-500 w-5"></i>
                              <span class="ml-2">${
                                getTipeInstansiLabel(ambulans.tipe_instansi) ||
                                "Tidak tersedia"
                              }</span>
                    </div>
                    <div class="flex items-center">
                              <i class="fas fa-${
                                ambulans.status === "gratis"
                                  ? "hand-holding-heart text-green-500"
                                  : "money-bill text-blue-500"
                              } w-5"></i>
                              <span class="ml-2">${
                                ambulans.status === "gratis"
                                  ? "Gratis"
                                  : formatPrice(ambulans.harga || 0)
                              }</span>
                    </div>
                          ${
                            distance
                              ? `
                    <div class="flex items-center">
                        <i class="fas fa-route text-blue-500 w-5"></i>
                        <span class="ml-2">${distance} km dari lokasi Anda</span>
                    </div>
                          `
                              : ""
                          }
                </div>
                      <div class="flex gap-2 mt-4">
                    <a href="tel:${ambulans.kontak}"
                             class="text-href flex items-center justify-center bg-green-500 text-white px-3 py-2 rounded text-center hover:bg-green-600 transition-colors text-sm">
                        <i class="fas fa-phone mr-2"></i>Telepon
                    </a>
                          ${
                            ambulans.whatsapp
                              ? `<a href="https://wa.me/${ambulans.whatsapp.replace(
                                  /\D/g,
                                  ""
                                )}" target="_blank"
                            class="flex items-center justify-center bg-[#25D366] text-white px-3 py-2 rounded text-center hover:bg-[#128C7E] transition-colors text-sm">
                            <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                              </a>`
                              : `<button disabled class="flex items-center justify-center bg-gray-300 text-white px-3 py-2 rounded text-center cursor-not-allowed text-sm">
                            <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                        </button>`
                          }
                </div>
                      ${
                        userLocation
                          ? `
                      <button onclick="getRoute([${ambulans.latitude}, ${
                              ambulans.longitude
                            }], '${ambulans.nama.replace(/'/g, "\\'")}')"
                        class="w-full mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors text-sm">
                    <i class="fas fa-directions mr-2"></i>Lihat Rute
                </button>
                      `
                          : ""
                      }
            `;

          return popupContent;
        }

        // Update markers
        function updateMarkers() {
          // Clear existing markers
          markers.forEach((marker) => map.removeLayer(marker));
          markers = [];

          // Get filtered data
          const filteredData = filterAmbulanceData();
          // console.log("Filtered ambulance data:", filteredData);

          if (!filteredData || filteredData.length === 0) {
            showToast(
              "Tidak ada ambulans yang sesuai dengan filter yang dipilih",
              "info"
            );
            return;
          }

          // Add new markers for filtered data only
          filteredData.forEach((ambulans) => {
            if (ambulans.latitude && ambulans.longitude) {
              const marker = L.marker([ambulans.latitude, ambulans.longitude], {
                icon: ambulanceIcon,
              });

              // Store ambulance data in marker
              marker.ambulansData = ambulans;

              // Create and bind popup
              marker.bindPopup(() => createPopupContent(ambulans));

              marker.addTo(map);
              markers.push(marker);
            }
          });

          // Fit bounds only if no user location is set
          if (markers.length > 0) {
            if (!userLocation) {
              const group = L.featureGroup(markers);
              map.fitBounds(group.getBounds(), {
                padding: [50, 50],
              });
            } else {
              // If user location exists, include it in the bounds
              const allPoints = [...markers, userMarker];
              const group = L.featureGroup(allPoints);
              map.fitBounds(group.getBounds(), {
                padding: [50, 50],
              });
            }
          }

          // Bring user marker to front if it exists
          if (userMarker && typeof userMarker.bringToFront === "function") {
            try {
              userMarker.bringToFront();
            } catch (error) {
              console.warn("Could not bring user marker to front:", error);
            }
          }
        }

        // Function to format price
        function formatPrice(price) {
          return new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          }).format(price);
        }

        // Update cards
        function updateCards() {
          const container = document.getElementById("ambulanceList");
          container.innerHTML = "";

          const filteredData = filterAmbulanceData();
          // console.log("Updating cards with filtered data:", filteredData);

          if (filteredData.length === 0) {
            container.innerHTML = `
                    <div class="col-span-3 text-center py-8">
                        <p class="text-gray-500">Tidak ada ambulans yang sesuai dengan filter yang dipilih</p>
                    </div>
                `;
            return;
          }

          filteredData.forEach((ambulance) => {
            const card = document.createElement("div");
            card.className =
              "bg-white rounded-lg shadow-lg p-4 hover:shadow-xl transition-all duration-300";

            // Format rating
            const rating = ambulance.rating ? Number(ambulance.rating) : 0;
            const ratingStars =
              "★".repeat(Math.round(rating)) +
              "☆".repeat(5 - Math.round(rating));

            let fasilitasArray = [];
            if (Array.isArray(ambulance.fasilitas)) {
              fasilitasArray = ambulance.fasilitas;
            } else if (typeof ambulance.fasilitas === "string") {
              try {
                // Log string fasilitas SEBELUM di-parse
                console.log(
                  `Parsing fasilitas for ambulance "${ambulance.nama}":`,
                  ambulance.fasilitas
                );
                fasilitasArray = JSON.parse(ambulance.fasilitas || "[]");
              } catch (e) {
                console.error(
                  `Error parsing fasilitas for ambulance "${ambulance.nama}":`,
                  ambulance.fasilitas,
                  e
                );
                fasilitasArray = []; // Fallback ke array kosong jika error
              }
            }

            // Format fasilitas
            const fasilitas = Array.isArray(ambulance.fasilitas)
              ? ambulance.fasilitas
              : typeof ambulance.fasilitas === "string"
              ? JSON.parse(ambulance.fasilitas || "[]")
              : [];

            card.innerHTML = `
                          <div class="flex justify-between items-start">
                              <div>
                                  <h3 class="text-lg font-semibold text-gray-800">${
                                    ambulance.nama
                                  }</h3>
                                  <p class="text-sm text-gray-500">${getTipeInstansiLabel(
                                    ambulance.tipe_instansi
                                  )}</p>
                    </div>
                              <div class="text-right">
                                  <span class="inline-block px-2 py-1 text-sm ${
                                    ambulance.status === "gratis"
                                      ? "bg-green-100 text-green-800"
                                      : "bg-blue-100 text-blue-800"
                                  } rounded-full font-medium">
                                      ${
                                        ambulance.status === "gratis"
                                          ? "GRATIS"
                                          : formatPrice(ambulance.harga || 0)
                                      }
                                  </span>
                              </div>
                          </div>

                          <!-- Rating & Reviews -->
                          <div class="mt-2 flex items-center space-x-2">
                              <div class="text-yellow-400">${ratingStars}</div>
                              <span class="text-sm text-gray-600">${rating.toFixed(
                                1
                              )}</span>
                              <span class="text-sm text-gray-400">(${
                                ambulance.jumlah_rating || 0
                              } ulasan)</span>
                          </div>

                          <!-- Alamat & Kontak -->
                          <div class="mt-3 space-y-2">
                              <div class="flex items-start space-x-2">
                                  <i class="fas fa-map-marker-alt text-red-500 mt-1"></i>
                                  <p class="text-sm text-gray-600 flex-1">${
                                    ambulance.alamat
                                  }, ${ambulance.kota}, ${
              ambulance.provinsi
            }</p>
                              </div>
                              <div class="flex items-center space-x-2">
                                  <i class="fas fa-phone text-green-500"></i>
                                  <a href="tel:${
                                    ambulance.kontak
                                  }" class="text-sm text-gray-600" hover:text-blue-800">${
              ambulance.kontak
            }</a>
                              </div>
                              ${
                                ambulance.whatsapp
                                  ? `
                              <div class="flex items-center space-x-2">
                                  <i class="fab fa-whatsapp text-green-500"></i>
                                  <a href="https://wa.me/${ambulance.whatsapp.replace(
                                    /\D/g,
                                    ""
                                  )}" class="text-sm text-gray-600" hover:text-blue-800">${
                                      ambulance.whatsapp
                                    }</a>
                              </div>
                              `
                                  : ""
                              }
                          </div>

                          <!-- Jenis Layanan & Jam Operasional -->
                          <div class="mt-3 space-y-2">
                              <div class="flex items-center space-x-2">
                                  <i class="fas fa-ambulance text-[#AA1919]"></i>
                                  <span class="text-sm text-gray-600">${getJenisLayananLabel(
                                    ambulance.jenis_layanan
                                  )}</span>
                              </div>
                              ${
                                ambulance.jam_operasional
                                  ? `
                              <div class="flex items-center space-x-2">
                                  <i class="fas fa-clock text-[#AA1919]"></i>
                                  <span class="text-sm text-gray-600">${ambulance.jam_operasional}</span>
                              </div>
                              `
                                  : ""
                              }
                          </div>

                          <!-- Fasilitas -->
                          ${
                            fasilitas.length > 0
                              ? `
                          <div class="mt-3">
                              <div class="flex flex-wrap gap-1">
                                  ${fasilitas
                                    .map(
                                      (f) => `
                                      <span class="inline-flex items-center px-2 py-1 bg-gray-100 text-xs text-gray-800 rounded-full">
                                    ${f}
                                </span>
                                  `
                                    )
                                    .join("")}
                        </div>
                    </div>
                          `
                              : ""
                          }

                          <!-- Action Buttons -->
                          <div class="mt-4 grid grid-cols-2 gap-2">
                              <button onclick="showReviewModal(${ambulance.id})"
                                      class="flex items-center justify-center px-3 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors text-sm">
                                  <i class="fas fa-star mr-2"></i>
                                  ${
                                    ambulance.jumlah_rating > 0
                                      ? "Lihat Review"
                                      : "Beri Review"
                                  }
                              </button>
                              ${
                                userLocation
                                  ? `
                                  <button onclick="getRoute([${
                                    ambulance.latitude
                                  }, ${
                                      ambulance.longitude
                                    }], '${ambulance.nama.replace(
                                      /'/g,
                                      "\\'"
                                    )}')"
                                          class="flex items-center justify-center px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm">
                                      <i class="fas fa-directions mr-2"></i>
                                      Lihat Rute
                                  </button>
                              `
                                  : `
                                  <button onclick="getCurrentLocation()"
                                          class="flex items-center justify-center px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm">
                                      <i class="fas fa-location-arrow mr-2"></i>
                                      Aktifkan Lokasi
                                  </button>
                              `
                              }
                    </div>
                `;

            container.appendChild(card);
          });
        }

        // Load provinsi dan kota dari indonesia.json
        async function loadProvinsiData() {
          try {
            const response = await fetch("/data/indonesia.json");
            const data = await response.json();

            const provinsiSelect = document.getElementById("filterProvinsi");
            provinsiSelect.innerHTML =
              '<option value="">Semua Provinsi</option>';

            Object.keys(data)
              .sort()
              .forEach((province) => {
                const option = document.createElement("option");
                option.value = province;
                option.textContent = province;
                provinsiSelect.appendChild(option);
              });

            // Store data for city filtering
            provinsiSelect.dataset.provinceData = JSON.stringify(data);
          } catch (error) {
            console.error("Error loading province data:", error);
            showToast("Gagal memuat data provinsi", "error");
          }
        }

        // Update kota based on selected province
        function updateKotaOptions(selectedProvinsi) {
          const provinsiSelect = document.getElementById("filterProvinsi");
          const kotaSelect = document.getElementById("filterKota");
          const data = JSON.parse(provinsiSelect.dataset.provinceData || "{}");

          kotaSelect.innerHTML = '<option value="">Semua Kota</option>';

          if (selectedProvinsi && data[selectedProvinsi]) {
            data[selectedProvinsi].sort().forEach((city) => {
              const option = document.createElement("option");
              option.value = city;
              option.textContent = city;
              kotaSelect.appendChild(option);
            });
            kotaSelect.disabled = false;
          } else {
            kotaSelect.disabled = true;
          }
        }

        // Initialize when page loads
        document.addEventListener("DOMContentLoaded", async () => {
          // Initialize map only if it hasn't been initialized
          if (!map) {
            initMap();
          }
          await loadProvinsiData();
          await loadAmbulanceData();
          await getCurrentLocation();
          setupEventListeners();
          updateUI();

          // Handle provinsi change
          document
            .getElementById("filterProvinsi")
            .addEventListener("change", (e) => {
              updateKotaOptions(e.target.value);
              handleFilterChange();
            });

          // Handle kota change
          document
            .getElementById("filterKota")
            .addEventListener("change", handleFilterChange);

          // Check authentication
          const token = localStorage.getItem("token");
          isAuthenticated = !!token;
        });

        // Function to get coordinates from city name
        async function getCoordinates(cityName, provinceName) {
          try {
            const query = `${cityName}, ${provinceName}, Indonesia`;
            const response = await fetch(
              `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                query
              )}`
            );
            const data = await response.json();

            if (data && data.length > 0) {
              return {
                lat: parseFloat(data[0].lat),
                lon: parseFloat(data[0].lon),
                boundingbox: data[0].boundingbox,
              };
            }
            return null;
          } catch (error) {
            console.error("Error getting coordinates:", error);
            return null;
          }
        }

        // Function to center map on selected city
        async function centerMapOnCity(cityName, provinceName) {
          const coords = await getCoordinates(cityName, provinceName);
          if (coords) {
            // Get markers in the selected city
            const cityMarkers = markers.filter((marker) => {
              const ambulans = marker.ambulansData;
              return ambulans && ambulans.kota === cityName;
            });

            if (cityMarkers.length > 0) {
              // Create a bounds object that includes all markers in the city
              const group = L.featureGroup(cityMarkers);
              map.fitBounds(group.getBounds(), {
                padding: [50, 50], // Add some padding around the bounds
                maxZoom: 13, // Limit maximum zoom level
              });
            } else {
              // If no markers in the city, use coordinates from geocoding
              map.setView([coords.lat, coords.lon], 13);
            }

            // Show toast message
            showToast(
              `Peta dipusatkan ke ${cityName}, ${provinceName}`,
              "success"
            );
          }
        }

        // Update filter options
        function updateFilters() {
          const provinsiSelect = document.getElementById("filterProvinsi");
          const kotaSelect = document.getElementById("filterKota");
          const selectedProvinsi = provinsiSelect.value;

          // Reset kota filter when provinsi changes
          if (provinsiSelect.dataset.lastValue !== selectedProvinsi) {
            kotaSelect.innerHTML = '<option value="">Semua Kota</option>';
            provinsiSelect.dataset.lastValue = selectedProvinsi;
          }

          // Show all unique cities from ambulance data
          const kotaSet = new Set();
          ambulanceData.forEach((ambulance) => {
            if (selectedProvinsi) {
              // If province is selected, only show cities from that province
              if (
                ambulance.provinsi.toUpperCase() === selectedProvinsi &&
                ambulance.kota
              ) {
                kotaSet.add(ambulance.kota);
              }
            } else {
              // If no province selected, show all cities
              if (ambulance.kota) {
                kotaSet.add(ambulance.kota);
              }
            }
          });

          // Update kota options
          const currentKota = kotaSelect.value;
          kotaSelect.innerHTML = '<option value="">Semua Kota</option>';
          Array.from(kotaSet)
            .sort()
            .forEach((kota) => {
              const option = document.createElement("option");
              option.value = kota;
              option.textContent = kota;
              if (kota === currentKota) {
                option.selected = true;
              }
              kotaSelect.appendChild(option);
            });

          // Update cards and map
          updateCards();
          updateMarkers();
        }

        // Helper function untuk menampilkan tipe instansi
        function getTipeInstansiLabel(value) {
          const labels = {
            rs: "Rumah Sakit",
            puskesmas: "Puskesmas",
            klinik: "Klinik",
            lainnya: "Lainnya",
          };
          return labels[value] || value;
        }

        // Add radius circle visualization
        let radiusCircle = null;

        function updateRadiusVisualization() {
          if (radiusCircle) {
            map.removeLayer(radiusCircle);
          }

          const radius = parseFloat(
            document.getElementById("filterRadius").value
          );
          if (userLocation && radius > 0) {
            radiusCircle = L.circle(userLocation, {
              radius: radius * 1000, // Convert km to meters
              color: "#AA1919",
              fillColor: "#AA1919",
              fillOpacity: 0.1,
              weight: 1,
            }).addTo(map);
          }
        }

        // Add statistics functions
        function updateStatistics() {
          updateAmbulanceTypeChart();
          updateAmbulanceStatusChart();
        }

        function updateAmbulanceTypeChart() {
          const typeCount = {};
          ambulanceData.forEach((ambulance) => {
            typeCount[ambulance.tipe_instansi] =
              (typeCount[ambulance.tipe_instansi] || 0) + 1;
          });

          const ctx = document
            .getElementById("ambulanceTypeChart")
            .getContext("2d");

          // Hancurkan chart sebelumnya jika ada
          if (ambulanceTypeChart) {
            ambulanceTypeChart.destroy();
          }

          ambulanceTypeChart = new Chart(ctx, {
            type: "pie",
            data: {
              labels: Object.keys(typeCount).map((type) =>
                getTipeInstansiLabel(type)
              ),
              datasets: [
                {
                  data: Object.values(typeCount),
                  backgroundColor: ["#AA1919", "#DC2626", "#EF4444", "#F87171"],
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "bottom",
                },
                title: {
                  display: true,
                  text: "Distribusi Tipe Ambulans",
                },
              },
            },
          });
        }

        function updateAmbulanceStatusChart() {
          const statusCount = {
            gratis: 0,
            berbayar: 0,
          };
          ambulanceData.forEach((ambulance) => {
            statusCount[ambulance.status]++;
          });

          const ctx = document
            .getElementById("ambulanceStatusChart")
            .getContext("2d");

          // Hancurkan chart sebelumnya jika ada
          if (ambulanceStatusChart) {
            ambulanceStatusChart.destroy();
          }

          ambulanceStatusChart = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: ["Gratis", "Berbayar"],
              datasets: [
                {
                  data: Object.values(statusCount),
                  backgroundColor: ["#059669", "#AA1919"],
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "bottom",
                },
                title: {
                  display: true,
                  text: "Status Layanan Ambulans",
                },
              },
            },
          });
        }

        // Variabel global untuk menyimpan rating yang dipilih
        let selectedRating = 0;

        // Fungsi untuk menampilkan modal review
        async function showReviewModal(ambulansId) {
          const reviewList = document.getElementById("reviewList");
          const modal = document.getElementById("reviewModal");
          const hiddenId = document.getElementById("reviewAmbulansId");

          reviewList.innerHTML = `<p class="text-sm text-gray-500">Memuat review...</p>`;
          hiddenId.value = ambulansId;

          try {
            const response = await fetch(`/api/reviews/${ambulansId}`); // Changed from /api/review to /api/reviews
            if (!response.ok) throw new Error("Gagal ambil review");

            const data = await response.json();
            console.log(data);

            if (data.length === 0) {
              reviewList.innerHTML = `<p class="text-sm text-gray-500">Belum ada review untuk ambulans ini.</p>`;
            } else {
              reviewList.innerHTML = data
                .map(
                  (review) => `
              <div class="mb-4 border-b pb-2">
                <div class="flex items-center justify-between">
                  <strong>${review.user_nama || "Anonim"}</strong>
                  <span class="text-yellow-400">${"★".repeat(
                    review.rating
                  )}${"☆".repeat(5 - review.rating)}</span>
                </div>
                <p class="text-sm text-gray-600">${
                  review.komentar || "(tanpa komentar)"
                }</p>
              </div>
            `
                )
                .join("");
            }
          } catch (err) {
            console.error("Error loading reviews:", err);
            reviewList.innerHTML = `<p class="text-red-500 text-sm">Gagal memuat review: ${err.message}</p>`;
          }

          modal.classList.remove("hidden");
          modal.classList.add("flex");
        }

        // Fungsi untuk mengirim review
        async function handleReviewSubmit(e) {
          e.preventDefault();

          try {
            // Check if user is authenticated
            const token = localStorage.getItem("token");
            if (!token) {
              showToast(
                "Anda harus login terlebih dahulu untuk memberikan review",
                "error"
              );
              setTimeout(() => {
                window.location.href = "/login.html";
              }, 2000);
              return;
            }

            const ambulansId =
              document.getElementById("reviewAmbulansId").value;
            const komentar = document.getElementById("reviewKomentar").value;
            const rating = selectedRating;

            // Validasi input
            if (!rating || rating < 1 || rating > 5) {
              showToast("Silakan beri rating antara 1-5 bintang", "error");
              return;
            }

            if (!ambulansId) {
              showToast("ID ambulans tidak valid", "error");
              return;
            }

            // Show loading state
            showToast("Mengirim review...", "info");

            const response = await fetch("/api/reviews", {
              // Changed from /api/review to /api/reviews
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                ambulans_id: parseInt(ambulansId),
                rating: parseInt(rating),
                komentar: komentar || "",
              }),
            });

            const result = await response.json();

            if (!response.ok) {
              if (response.status === 401) {
                // Token expired atau tidak valid
                localStorage.removeItem("token");
                showToast(
                  "Sesi Anda telah berakhir. Silakan login kembali",
                  "error"
                );
                setTimeout(() => {
                  window.location.href = "/login.html";
                }, 2000);
                return;
              }
              throw new Error(result.message || "Gagal mengirim review");
            }

            showToast(result.message || "Review berhasil dikirim", "success");

            // Reset form
            document.getElementById("reviewKomentar").value = "";
            selectedRating = 0;
            updateStarButtons();

            // Refresh reviews
            await showReviewModal(ambulansId);

            // Refresh data ambulans untuk update rating
            await loadAmbulanceData();
          } catch (error) {
            console.error("Error submitting review:", error);
            showToast(
              error.message || "Gagal mengirim review. Silakan coba lagi nanti",
              "error"
            );
          }
        }

        // Fungsi untuk mengupdate tampilan bintang rating
        function updateStarButtons() {
          document.querySelectorAll(".star-btn").forEach((btn) => {
            const rating = parseInt(btn.getAttribute("data-rating"));
            btn.classList.toggle("text-yellow-400", rating <= selectedRating);
            btn.classList.toggle("text-gray-300", rating > selectedRating);
          });
        }

        // Fungsi untuk menutup modal review
        function closeReviewModal() {
          const modal = document.getElementById("reviewModal");
          modal.classList.add("hidden");

          // Reset form
          document.getElementById("reviewKomentar").value = "";
          selectedRating = 0;
          updateStarButtons();
        }

        // Event Listeners yang diperlukan
        document.addEventListener("DOMContentLoaded", () => {
          // Event listener untuk tombol bintang
          document.querySelectorAll(".star-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              selectedRating = parseInt(btn.getAttribute("data-rating"));
              updateStarButtons();
            });
          });

          // Event listener untuk form review
          document
            .getElementById("reviewForm")
            .addEventListener("submit", handleReviewSubmit);

          // Event listener untuk tombol close modal
          document
            .querySelector("#reviewModal [onclick='closeReviewModal()']")
            .addEventListener("click", closeReviewModal);
        });

        // Add event listener for radius filter
        document
          .getElementById("filterRadius")
          .addEventListener("change", () => {
            updateRadiusVisualization();
            handleFilterChange();
          });

        // Province and City data
        const provinceData = {
          "Jawa Timur": [
            "Malang",
            "Surabaya",
            "Sidoarjo",
            "Batu",
            "Blitar",
            "Kediri",
            "Pasuruan",
            "Probolinggo",
          ],
          "Jawa Barat": [
            "Bandung",
            "Bogor",
            "Depok",
            "Bekasi",
            "Cimahi",
            "Tasikmalaya",
            "Sukabumi",
          ],
          "DKI Jakarta": [
            "Jakarta Pusat",
            "Jakarta Utara",
            "Jakarta Barat",
            "Jakarta Selatan",
            "Jakarta Timur",
          ],
          // Add more provinces and cities as needed
        };

        // Initialize province dropdown
        const provinceSelect = document.getElementById("filterProvinsi");
        Object.keys(provinceData).forEach((province) => {
          const option = document.createElement("option");
          option.value = province;
          option.textContent = province;
          provinceSelect.appendChild(option);
        });

        // Update city dropdown based on selected province
        function updateCityOptions(province) {
          const citySelect = document.getElementById("filterKota");
          citySelect.innerHTML = '<option value="">Semua Kota</option>';

          if (province && provinceData[province]) {
            provinceData[province].forEach((city) => {
              const option = document.createElement("option");
              option.value = city;
              option.textContent = city;
              citySelect.appendChild(option);
            });
            citySelect.disabled = false;
          } else {
            citySelect.disabled = true;
          }
        }

        // Add event listeners for filters
        document
          .getElementById("filterProvinsi")
          .addEventListener("change", function () {
            updateKotaOptions(this.value);
            handleFilterChange();
          });

        document
          .getElementById("filterKota")
          .addEventListener("change", handleFilterChange);
        document
          .getElementById("filterTipe")
          .addEventListener("change", handleFilterChange);
        document
          .getElementById("filterJenisLayanan")
          .addEventListener("change", handleFilterChange);
        document
          .getElementById("filterStatus")
          .addEventListener("change", handleFilterChange);
        document
          .getElementById("filterRadius")
          .addEventListener("change", () => {
            updateRadiusVisualization();
            handleFilterChange();
          });

        // Initialize city dropdown
        updateCityOptions(provinceSelect.value);

        // Helper function untuk menampilkan jenis layanan
        function getJenisLayananLabel(value) {
          const labels = {
            gawat_darurat: "Gawat Darurat",
            non_gawat_darurat: "Non Gawat Darurat",
            transportasi: "Transportasi",
            jenazah: "Jenazah",
          };
          return labels[value] || value;
        }

        // Check authentication on page load
        document.addEventListener("DOMContentLoaded", async () => {
          const token = localStorage.getItem("token");
          isAuthenticated = !!token;

          initMap();
          await loadAmbulanceData();
          await getCurrentLocation();
          setupEventListeners();
          updateUI();
        });

        // Add this function
        function setupEventListeners() {
          // Star rating functionality
          document.querySelectorAll(".star-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const rating = parseInt(e.target.dataset.rating);
              document.querySelectorAll(".star-btn").forEach((star, index) => {
                if (index < rating) {
                  star.classList.remove("text-gray-300");
                  star.classList.add("text-yellow-400");
                } else {
                  star.classList.remove("text-yellow-400");
                  star.classList.add("text-gray-300");
                }
              });
            });
          });

          // Review form submission
          document
            .getElementById("reviewForm")
            .addEventListener("submit", handleReviewSubmit);
        }

        // Load province data from local file
        async function loadProvinceData() {
          try {
            const response = await fetch("/data/indonesia.json");
            const provinces = await response.json();

            const provinsiSelect = document.getElementById("filterProvinsi");
            provinsiSelect.innerHTML =
              '<option value="">Semua Provinsi</option>';

            Object.keys(provinces).forEach((province) => {
              const option = document.createElement("option");
              option.value = province;
              option.textContent = province;
              provinsiSelect.appendChild(option);
            });
          } catch (error) {
            console.error("Error loading provinces:", error);
            showToast("Gagal memuat data provinsi", "error");
          }
        }

        // Load cities based on selected province
        async function loadCities(province) {
          if (!province) {
            const kotaSelect = document.getElementById("filterKota");
            kotaSelect.innerHTML = '<option value="">Semua Kota</option>';
            kotaSelect.disabled = true;
            return;
          }

          try {
            const response = await fetch("/data/indonesia.json");
            const data = await response.json();
            const cities = data[province] || [];

            const kotaSelect = document.getElementById("filterKota");
            kotaSelect.innerHTML = '<option value="">Semua Kota</option>';

            cities.forEach((city) => {
              const option = document.createElement("option");
              option.value = city;
              option.textContent = city;
              kotaSelect.appendChild(option);
            });

            kotaSelect.disabled = false;
          } catch (error) {
            console.error("Error loading cities:", error);
            showToast("Gagal memuat data kota", "error");
          }
        }

        // Event listener for province change
        document
          .getElementById("filterProvinsi")
          .addEventListener("change", function () {
            loadCities(this.value);
          });

        // Load provinces on page load
        document.addEventListener("DOMContentLoaded", loadProvinceData);
      </script>
    </div>

    <!-- Footer -->
    <footer
      class="bg-gradient-to-r from-[#AA1919] to-[#8B0000] text-white w-full"
    >
      <div class="container mx-auto px-4 py-12">
        <div
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-10 mb-10"
        >
          <!-- Brand Info -->
          <div class="space-y-4">
            <div class="flex items-center mb-4">
              <i class="fas fa-ambulance text-2xl text-white"></i>
              <span class="text-2xl font-bold text-white ml-2">AmbuLink</span>
            </div>
            <p class="text-sm leading-relaxed">
              Menghubungkan Anda dengan layanan ambulans terdekat secara cepat
              dan efisien.
            </p>
          </div>

          <!-- Kontak -->
          <div class="space-y-4">
            <h4 class="text-lg sm:text-xl font-bold">Kontak</h4>
            <ul class="space-y-2 text-sm">
              <li class="flex items-center">
                <i class="fas fa-phone mr-2"></i>
                Emergency: 119
              </li>
              <li class="flex items-center">
                <i class="fas fa-envelope mr-2"></i>
                info@ambulink.id
              </li>
              <li class="flex items-center">
                <i class="fas fa-map-marker-alt mr-2"></i>
                Jakarta, Indonesia
              </li>
            </ul>
          </div>

          <!-- Sosial Media -->
          <div class="space-y-4">
            <h4 class="text-lg sm:text-xl font-bold">Ikuti Kami</h4>
            <div class="flex space-x-4 text-white">
              <a href="#" class="hover:text-red-200 transition-colors">
                <i class="fab fa-facebook-f text-xl"></i>
              </a>
              <a href="#" class="hover:text-red-200 transition-colors">
                <i class="fab fa-twitter text-xl"></i>
              </a>
              <a href="#" class="hover:text-red-200 transition-colors">
                <i class="fab fa-instagram text-xl"></i>
              </a>
              <a href="#" class="hover:text-red-200 transition-colors">
                <i class="fab fa-youtube text-xl"></i>
              </a>
            </div>
          </div>

          <!-- Survei -->
          <div class="space-y-4">
            <h5 class="text-lg font-semibold">Survei Kepuasan</h5>
            <a
              href="mailto:info@ambulink.id"
              class="inline-block bg-white text-[#AA1919] px-4 py-2 rounded-lg hover:bg-red-100 transition-colors duration-300 text-sm font-medium"
            >
              Beri Feedback
            </a>
          </div>
        </div>
      </div>
    </footer>

    <!-- Chatbot Trigger Button -->
    <!-- Chatbot Button -->
    <button
      id="chatbotToggle"
      class="fixed bottom-6 right-6 bg-[#AA1919] text-white p-4 rounded-full shadow-lg hover:bg-[#8B0000] transition-all duration-300 flex items-center justify-center z-50 group"
    >
      <i
        class="fas fa-comment-dots text-2xl group-hover:scale-110 transition-transform"
      ></i>
    </button>

    <!-- Chatbot Window -->
    <div
      id="chatbotWindow"
      class="hidden fixed bottom-20 right-6 w-[400px] max-w-full bg-white rounded-xl shadow-2xl border border-red-100 flex flex-col z-50"
    >
      <!-- Header -->
      <div
        class="bg-gradient-to-r from-[#AA1919] to-[#8B0000] text-white px-6 py-4 rounded-t-xl flex justify-between items-center"
      >
        <div class="flex items-center space-x-3">
          <div
            class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"
          >
            <i class="fas fa-robot text-xl"></i>
          </div>
          <div>
            <h3 class="font-bold text-lg">AmbuBot</h3>
            <p class="text-xs text-white/80">Online - Siap membantu</p>
          </div>
        </div>
        <button
          id="chatbotClose"
          class="text-white/80 hover:text-white transition-colors"
        >
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <!-- Messages Container -->
      <div
        id="chatMessages"
        class="flex-1 p-6 space-y-6 overflow-y-auto bg-gray-50/50"
        style="max-height: 500px; min-height: 350px"
      >
        <!-- Messages will be inserted here -->
      </div>

      <!-- Typing Indicator -->
      <div
        id="typingIndicator"
        class="hidden px-6 py-3 border-t border-gray-100 bg-white"
      >
        <div class="flex items-center space-x-2">
          <div
            class="w-8 h-8 rounded-full bg-[#AA1919] flex items-center justify-center text-white flex-shrink-0"
          >
            <i class="fas fa-robot text-sm"></i>
          </div>
          <div class="flex space-x-1">
            <div class="w-2 h-2 bg-gray-300 rounded-full animate-bounce"></div>
            <div
              class="w-2 h-2 bg-gray-300 rounded-full animate-bounce"
              style="animation-delay: 0.2s"
            ></div>
            <div
              class="w-2 h-2 bg-gray-300 rounded-full animate-bounce"
              style="animation-delay: 0.4s"
            ></div>
          </div>
        </div>
      </div>

      <!-- Input Form -->
      <div class="border-t border-gray-100 p-4 bg-white">
        <form id="chatForm" class="flex items-center space-x-3">
          <input
            type="text"
            id="chatInput"
            class="flex-1 bg-gray-50 border border-gray-200 rounded-full px-4 py-3 text-sm focus:outline-none focus:border-[#AA1919] focus:ring-1 focus:ring-[#AA1919] transition-all placeholder-gray-400"
            placeholder="Ketik pesan Anda..."
          />
          <button
            type="submit"
            class="bg-[#AA1919] text-white p-3 rounded-full hover:bg-[#8B0000] transition-colors flex items-center justify-center w-12 h-12 hover:scale-105 active:scale-95 transform"
          >
            <i class="fas fa-paper-plane text-sm"></i>
          </button>
        </form>
      </div>
    </div>
  </body>
</html>
